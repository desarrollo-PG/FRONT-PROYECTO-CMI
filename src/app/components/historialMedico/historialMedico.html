<!-- historialMedico.html - TEMPLATE ACTUALIZADO -->
<div class="content-area" [class.sidebar-expanded]="sidebarExpanded">
  <app-sidebar [userInfo]="userInfo"></app-sidebar>
  <div class="main-content">
    <header class="page-header">
      <h1>
        <div class="logo">
          <img src="assets/img/LogoFraijanes.png" alt="Logo Fraijanes">
        </div>
        Historial Clínico
      </h1>
      
      <div class="date-info">
        Fecha: {{ currentDate | date:'dd/MM/yy' }}
      </div>
    </header>

    <div class="main-container" >
      <div class="controls-section">
        <div class="search-controls">
          <div class="search-container">
            <div class="patient-info-card" *ngIf="infoPaciente">
              <div class="patient-card-header">
                <div class="patient-avatar">
                  <div class="avatar-circle">
                    <img 
                      *ngIf="fotoPacienteUrl" 
                      [src]="fotoPacienteUrl" 
                      [alt]="infoPaciente.nombres + ' ' + infoPaciente.apellidos"
                      class="patient-photo"
                    >
                    <i *ngIf="!fotoPacienteUrl" class="fas fa-user"></i>
                  </div>
                </div>
                <div class="patient-basic-info">
                  <h2>{{ infoPaciente.nombres }} {{ infoPaciente.apellidos }}</h2>
                  <p class="expediente-number" *ngIf="infoPaciente.expedientes && infoPaciente.expedientes.length > 0">
                    Expediente N°. {{ infoPaciente.expedientes[0].numeroexpediente }}
                  </p>
                  <p class="patient-age" *ngIf="infoPaciente.fechanacimiento">
                    Edad: {{ historialService.calcularEdad(infoPaciente.fechanacimiento) }} años
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="table-container">
        <div class="main-card" *ngIf="currentView === 'historial'">
          <div class="historial-header">
            <h3>Historial de Sesiones</h3>
            <div class="header-buttons">
              <button class="btn-nueva-sesion" (click)="mostrarNuevaSesion()">
                <i class="fas fa-plus"></i> Nueva Sesión
              </button>
            </div>
          </div>

          <div *ngIf="loading" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            Cargando historial...
          </div>

          <div class="sesiones-grid" *ngIf="!loading">
            <div 
              class="sesion-card" 
              *ngFor="let sesion of historialSesiones"
              (click)="mostrarDiagnostico(sesion)"
            >
              <div class="sesion-fecha">
                {{ formatearFecha(sesion.fecha) }}
              </div>
              <div class="sesion-content">
                <h4>Control y registro de sesiones</h4>
                <p class="sesion-motivo">{{ sesion.motivoconsulta | slice:0:100 }}...</p>
                <div class="sesion-doctor" *ngIf="sesion.usuario">
                  Dr. {{ sesion.usuario.nombres }} {{ sesion.usuario.apellidos }}
                </div>
              </div>
              <div class="sesion-status">
                <span class="status-diagnostico" [class.completado]="sesion.diagnosticotratamiento">
                  Diagnóstico
                </span>
                <button 
                  class="btn-eliminar" 
                  (click)="eliminarSesion(sesion); $event.stopPropagation()"
                  title="Eliminar sesión"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>

            <div *ngIf="historialSesiones.length === 0" class="empty-state">
              <p>No hay sesiones registradas para este paciente</p>
            </div>
          </div>
        </div>

        <div class="main-card" *ngIf="currentView === 'notas-rapidas'">
          <div class="historial-header">
            <h3>Notas y Recordatorios</h3>
            <div class="header-actions">
              <button class="btn-volver" (click)="mostrarHistorial()">
                <i class="fas fa-arrow-left"></i> Volver
              </button>
            </div>
          </div>

          <div *ngIf="loading" class="loading-state">
            <i class="fas fa-spinner fa-spin"></i>
            Cargando notas...
          </div>

          <div class="notas-container" *ngIf="!loading">
            <div 
              class="nota-card" 
              *ngFor="let sesion of historialSesiones"
            >
              <div class="nota-header">
                <div class="nota-fecha">
                  {{ formatearFecha(sesion.fecha) }}
                </div>
                <div class="nota-doctor" *ngIf="sesion.usuario">
                  Dr. {{ sesion.usuario.nombres }} {{ sesion.usuario.apellidos }}
                </div>
              </div>

              <div class="nota-content">
                <!-- Solo Recordatorios -->
                <div class="nota-section" *ngIf="sesion.recordatorio">
                  <h5><i class="fas fa-bell"></i> Recordatorios importantes:</h5>
                  <p class="recordatorio-text">{{ sesion.recordatorio }}</p>
                </div>

                <!-- Mostrar mensaje si no hay recordatorios -->
                <div class="nota-empty" *ngIf="!sesion.recordatorio">
                  <i class="fas fa-info-circle"></i>
                  <span>No hay recordatorios para esta sesión</span>
                </div>
              </div>

              <div class="nota-footer">
                <button 
                  class="btn-ver-completo" 
                  (click)="mostrarDiagnostico(sesion)"
                  title="Ver sesión completa"
                >
                  <i class="fas fa-eye"></i> Ver completo
                </button>
              </div>
            </div>

            <div *ngIf="historialSesiones.length === 0" class="empty-state">
              <i class="fas fa-clipboard-list"></i>
              <h4>No hay notas registradas</h4>
              <p>No hay sesiones con notas o recordatorios para este paciente</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-backdrop" *ngIf="currentView === 'nueva-sesion'" (click)="mostrarHistorial()">
    <div class="modal-content-large" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <h3>
          <i class="fas fa-notes-medical"></i>
          Control y Registro de sesiones
        </h3>
        <button class="modal-close" (click)="mostrarHistorial()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body con Scroll -->
      <div class="modal-body-scroll">
        <form [formGroup]="sesionForm">
          <div class="form-section">
            <div class="section-title">
              <i class="fas fa-file-medical"></i>
              Información de la Sesión
            </div>
            
            <div class="form-grid">
              <div class="form-group ancho-completo">
                <label>
                  Motivo de Consulta
                  <span class="required">*</span>
                </label>
                <input 
                  type="text" 
                  formControlName="motivoconsulta"
                  class="entrada-formulario"
                  [class.error]="isFieldInvalid(sesionForm, 'motivoconsulta')"
                  placeholder="Describe el motivo de la consulta"
                >
                <div class="texto-error" *ngIf="isFieldInvalid(sesionForm, 'motivoconsulta')">
                  {{ getFieldError(sesionForm, 'motivoconsulta') }}
                </div>
              </div>

              <!-- Notas de Sesión - COLUMNA 1 -->
              <div class="form-group">
                <label>
                  Notas de la Sesión
                </label>
                <textarea 
                  formControlName="notaconsulta"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Médico agrega sus notas."
                ></textarea>
              </div>

              <!-- Recordatorios - COLUMNA 2 -->
              <div class="form-group">
                <label>
                  Recordatorios Importantes
                  <span class="optional">(Opcional)</span>
                </label>
                <textarea 
                  formControlName="recordatorio"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Médico agrega algún dato importante."
                ></textarea>
              </div>

              <!-- Evolución - COLUMNA 1 -->
              <div class="form-group">
                <label>
                  Evolución del Paciente
                </label>
                <textarea 
                  formControlName="evolucion"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Anota el progreso del paciente"
                ></textarea>
              </div>

              <!-- Diagnóstico - COLUMNA 2 -->
              <div class="form-group">
                <label>
                  Diagnóstico y Tratamiento
                </label>
                <textarea 
                  formControlName="diagnosticotratamiento"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Diagnóstico y tratamiento aplicado"
                ></textarea>
              </div>

            </div>
          </div>

          <!-- Sección de Archivos -->
          <div class="form-section">
            <div class="section-title">
              <i class="fas fa-paperclip"></i>
              Archivos Adjuntos
            </div>
            
            <div class="file-upload-area">
              <input 
                type="file" 
                id="archivos-nueva-sesion"
                multiple 
                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.webp"
                (change)="onFilesSelected($event)"
                class="file-input"
                style="display: none;"
              >
              
              <label for="archivos-nueva-sesion" class="file-upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar archivos</span>
              </label>
              
              <!-- Lista de archivos seleccionados -->
              <div class="selected-files" *ngIf="selectedFiles.length > 0">
                <h5>
                  <i class="fas fa-check-circle"></i>
                  Archivos seleccionados ({{ selectedFiles.length }})
                </h5>
                <div class="file-list">
                  <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
                    <div class="file-info">
                      <i class="fas fa-file" 
                        [class.fa-file-pdf]="file.type === 'application/pdf'"
                        [class.fa-file-word]="file.type.includes('word')"
                        [class.fa-file-excel]="file.type.includes('excel') || file.type.includes('sheet')"
                        [class.fa-file-image]="file.type.startsWith('image/')">
                      </i>
                      <div class="file-details">
                        <span class="file-name">{{ file.name }}</span>
                        <span class="file-size">({{ formatFileSize(file.size) }})</span>
                      </div>
                    </div>
                    <button 
                      type="button" 
                      class="btn-remove-file"
                      (click)="selectedFiles.splice(i, 1)"
                      title="Eliminar archivo"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- Footer con botones -->
      <div class="modal-footer">
        <div class="modal-actions">
          <button 
            type="button" 
            class="btn-cancel"
            (click)="mostrarHistorial()"
          >
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn-save" 
            (click)="crearSesion()"
            [disabled]="sesionForm.invalid || loading || archivosSubiendo"
          >
            <span *ngIf="loading || archivosSubiendo">
              <i class="fas fa-spinner fa-spin"></i> 
              {{ archivosSubiendo ? 'Subiendo archivos...' : 'Guardando...' }}
            </span>
            <span *ngIf="!loading && !archivosSubiendo">
              <i class="fas fa-save"></i>
              Guardar Sesión
            </span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- ✅ MODAL EDITAR SESIÓN (DIAGNÓSTICO) CON ARCHIVOS -->
  <div class="modal-backdrop" *ngIf="currentView === 'diagnostico'" (click)="mostrarHistorial()">
    <div class="modal-content-large" (click)="$event.stopPropagation()">
      
      <!-- Header del Modal -->
      <div class="modal-header">
        <h3>
          <i class="fas fa-edit"></i>
          Editar Sesión Clínica
        </h3>
        <button class="modal-close" (click)="mostrarHistorial()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Body con Scroll -->
      <div class="modal-body-scroll">
        <!-- Formulario usando las mismas clases -->
        <form [formGroup]="diagnosticoForm">
          
          <!-- Sección Principal -->
          <div class="form-section">
            <div class="section-title">
              <i class="fas fa-file-medical"></i>
              Información de la Sesión
            </div>
            
            <div class="form-grid">
              
              <!-- Motivo de Consulta - ANCHO COMPLETO -->
              <div class="form-group ancho-completo">
                <label>
                  Motivo de Consulta
                </label>
                <input 
                  type="text"
                  formControlName="motivoconsulta"
                  class="entrada-formulario"
                  placeholder="Motivo de consulta"
                >
              </div>

              <!-- Notas de Sesión - COLUMNA 1 -->
              <div class="form-group">
                <label>
                  Notas de la Sesión
                </label>
                <textarea 
                  formControlName="notaconsulta"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Médico agrega sus notas."
                ></textarea>
              </div>

              <!-- Recordatorios - COLUMNA 2 -->
              <div class="form-group">
                <label>
                  Recordatorios Importantes
                  <span class="optional">(Opcional)</span>
                </label>
                <textarea 
                  formControlName="recordatorio"
                  class="area-texto-formulario"
                  rows="5"
                  placeholder="Médico agrega algún dato importante."
                ></textarea>
              </div>
              
              <div class="form-group">
                <label>
                  Evolución del Paciente
                </label>
                <textarea 
                  formControlName="evolucion"
                  class="area-texto-formulario grande"
                  rows="6"
                  placeholder="Anota el progreso del paciente"
                ></textarea>
              </div>

              <div class="form-group">
                <label>
                  Diagnóstico y Tratamiento
                </label>
                <textarea 
                  formControlName="diagnosticotratamiento"
                  class="area-texto-formulario grande"
                  rows="6"
                  placeholder="Diagnóstico y Tratamiento"
                ></textarea>
              </div>

            </div>
          </div>

          <!-- Sección de Archivos Existentes -->
          <div class="form-section" *ngIf="archivosExistentes.length > 0">
            <div class="section-title">
              <i class="fas fa-folder-open"></i>
              Archivos de esta Sesión
            </div>
            
            <div class="selected-files">
              <div class="file-list">
                <div class="file-item archivo-existente" *ngFor="let archivo of archivosExistentes">
                  <div class="file-info">
                    <i class="fas fa-file" 
                      [class.fa-file-pdf]="archivo.tipo === 'documento'"
                      [class.fa-file-image]="archivo.tipo === 'imagen'">
                    </i>
                    <div class="file-details">
                      <span class="file-name">{{ archivo.nombreOriginal || archivo.nombre }}</span>
                      <span class="file-size" *ngIf="archivo.tamano">({{ formatFileSize(archivo.tamano) }})</span>
                    </div>
                  </div>
                  <button 
                    type="button"
                    class="btn-download-file"
                    (click)="descargarArchivo(archivo)"
                    title="Descargar archivo"
                  >
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección de Archivos Adicionales -->
          <div class="form-section">
            <div class="section-title">
              <i class="fas fa-paperclip"></i>
              Archivos Adicionales
            </div>
            
            <div class="file-upload-area">
              <input 
                type="file" 
                id="archivos-diagnostico"
                multiple 
                accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.webp"
                (change)="onFilesSelected($event)"
                class="file-input"
                style="display: none;"
              >
              
              <label for="archivos-diagnostico" class="file-upload-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Seleccionar archivos adicionales</span>
              </label>
              
              <!-- Lista de archivos seleccionados -->
              <div class="selected-files" *ngIf="selectedFiles.length > 0">
                <h5>
                  <i class="fas fa-check-circle"></i>
                  Archivos seleccionados ({{ selectedFiles.length }})
                </h5>
                <div class="file-list">
                  <div class="file-item" *ngFor="let file of selectedFiles; let i = index">
                    <div class="file-info">
                      <i class="fas fa-file" 
                        [class.fa-file-pdf]="file.type === 'application/pdf'"
                        [class.fa-file-word]="file.type.includes('word')"
                        [class.fa-file-excel]="file.type.includes('excel') || file.type.includes('sheet')"
                        [class.fa-file-image]="file.type.startsWith('image/')">
                      </i>
                      <div class="file-details">
                        <span class="file-name">{{ file.name }}</span>
                        <span class="file-size">({{ formatFileSize(file.size) }})</span>
                      </div>
                    </div>
                    <button 
                      type="button" 
                      class="btn-remove-file"
                      (click)="selectedFiles.splice(i, 1)"
                      title="Eliminar archivo"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- Footer con botones -->
      <div class="modal-footer">
        <div class="modal-actions">
          <button 
            type="button" 
            class="btn-cancel"
            (click)="mostrarHistorial()"
          >
            <i class="fas fa-times"></i>
            Cancelar
          </button>
          <button 
            type="button" 
            class="btn-save" 
            (click)="guardarDiagnostico()"
            [disabled]="loading || archivosSubiendo"
          >
            <span *ngIf="loading || archivosSubiendo">
              <i class="fas fa-spinner fa-spin"></i> 
              {{ archivosSubiendo ? 'Subiendo archivos...' : 'Guardando...' }}
            </span>
            <span *ngIf="!loading && !archivosSubiendo">
              <i class="fas fa-save"></i>
              Guardar Cambios
            </span>
          </button>
        </div>
      </div>

    </div>
  </div>

</div>