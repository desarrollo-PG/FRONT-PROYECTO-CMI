<!-- expediente.html -->
<div class="content-area" [class.sidebar-expanded]="barraLateralExpandida">
  <app-sidebar [userInfo]="informacionUsuario"></app-sidebar>
  <div class="main-content">
    <header class="page-header">
      <h1>
        <div class="logo">
          <img src="assets/img/LogoFraijanes.png" alt="Logo Fraijanes">
        </div>
        Expedientes
      </h1>
      
      <div class="date-info">
        Fecha: {{ currentDate | date:'dd/MM/yy' }}
      </div>
    </header>

    <div class="main-container" *ngIf="vistaActual === 'lista'">
      <div class="controls-section">
        <div class="search-controls">
          <div class="search-container">
            <input 
              type="text" 
              class="search-input" 
              placeholder="Buscar"
              [(ngModel)]="terminoBusqueda"
              (input)="filtrarExpedientes()"
            >
          </div>
          <button class="add-btn" (click)="mostrarFormulario()" *ngIf="vistaActual === 'lista'">
            Crear Expediente
          </button>
        </div>
      </div>
      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>Número de Expediente</th>
              <th>Historia de Enfermedad</th>
              <th>Paciente Asignado</th>
              <th>Fecha de Creación</th>
              <th>Editar</th>
              <th>Eliminar</th>
            </tr>
          </thead>

          <!-- TABLA CORREGIDA - Reemplaza la sección de la tabla en tu HTML -->

          <tbody>
            <tr *ngFor="let expediente of paginatedExpedientes" class="table-row">
              <td class="user-name" (click)="verExpediente(expediente)">
                {{ expediente.numeroexpediente }}
              </td>
              <td class="vista-previa-historia">
                {{ expediente.historiaenfermedad ? 
                    (expediente.historiaenfermedad.length > 50 ? 
                      expediente.historiaenfermedad.substring(0, 50) + '...' : 
                      expediente.historiaenfermedad) : 'No especificada' }}
              </td>
              <td>
                <div *ngIf="expediente.paciente && expediente.paciente.length > 0" class="informacion-paciente">
                  <div class="nombre-paciente">
                    {{ expediente.paciente[0].nombres || 'N/A' }} {{ expediente.paciente[0].apellidos || '' }}
                  </div>
                  <div class="cui-paciente">
                    CUI: {{ expediente.paciente[0].cui || 'N/A' }}
                  </div>
                </div>
                
                <div *ngIf="expediente.fkpaciente && (!expediente.paciente || expediente.paciente.length === 0)" class="paciente-no-cargado">
                  <div class="id-paciente">ID Paciente: {{ expediente.fkpaciente }}</div>
                  <div class="estado-carga">Datos no disponibles</div>
                </div>
                
                <div *ngIf="!expediente.fkpaciente" class="sin-paciente">
                  Sin paciente asignado
                </div>
              </td>
              <td>{{ expediente.fechacreacion | date:'dd/MM/yyyy' }}</td>

                          
              <!-- BOTÓN EDITAR -->
              <td>
                <div class="action-buttons">
                  <button 
                    class="action-btn edit-btn" 
                    (click)="editarExpediente(expediente)"
                    title="Editar"
                  >
                  Editar
                  </button>
                </div>
              </td>
              
              <!-- BOTÓN ELIMINAR -->
              <td>
                <div class="action-buttons">
                  <button 
                    class="action-btn delete-btn" 
                    (click)="eliminarExpediente(expediente.idexpediente!)"
                    title="Eliminar"
                  >
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" *ngIf="totalItems > 0">
        <!-- Navegación de páginas (solo si hay más de 1 página) -->
        <div class="pagination-info" *ngIf="totalPages > 1">
          <!-- Botón anterior -->
          <button 
            class="pagination-btn" 
            [class.disabled]="currentPage === 1"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
          >
            <i class="fas fa-chevron-left"></i>
          </button>

          <!-- Primera página -->
          <button 
            *ngIf="getPages()[0] > 1"
            class="pagination-btn"
            (click)="goToPage(1)"
          >
            1
          </button>
          
          <!-- Puntos suspensivos si hay salto -->
          <span *ngIf="getPages()[0] > 2" class="pagination-dots">...</span>

          <!-- Páginas visibles -->
          <button 
            *ngFor="let page of getPages()"
            class="pagination-btn"
            [class.active]="page === currentPage"
            (click)="goToPage(page)"
          >
            {{ page }}
          </button>

          <!-- Puntos suspensivos si hay salto al final -->
          <span *ngIf="getPages()[getPages().length - 1] < totalPages - 1" class="pagination-dots">...</span>

          <!-- Última página -->
          <button 
            *ngIf="getPages()[getPages().length - 1] < totalPages"
            class="pagination-btn"
            (click)="goToPage(totalPages)"
          >
            {{ totalPages }}
          </button>

          <!-- Botón siguiente -->
          <button 
            class="pagination-btn" 
            [class.disabled]="currentPage === totalPages"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
          >
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>

        <!-- Mostrar mensaje si solo hay una página -->
        <div *ngIf="totalPages <= 1" class="pagination-single">
          Página 1 de 1
        </div>

        <!-- Selector de elementos por página -->
        <div class="items-per-page">
          <label>Mostrar:</label>
          <select [(ngModel)]="itemsPerPage" (ngModelChange)="onItemsPerPageChange()">
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="20">20</option>
            <option [value]="50">50</option>
          </select>
          <span>por página</span>
        </div>
      </div>

      <div *ngIf="expedientesFiltrados.length === 0 && !cargando" class="estado-vacio">
        <i class="fas fa-folder-open"></i>
        <h3>No se encontraron expedientes</h3>
        <p>No hay expedientes que coincidan con su búsqueda</p>
        <button class="boton-crear-primero" (click)="mostrarFormulario()">
          <i class="fas fa-plus"></i> Crear primer expediente
        </button>
      </div>

      <!-- Estado de carga -->
      <div *ngIf="cargando" class="estado-carga">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Cargando expedientes...</p>
      </div>
    </div>
  </div>

  <!-- Modal de formulario -->
  <div class="modal-backdrop" *ngIf="vistaActual === 'formulario'" (click)="cerrarModalInterno()">
    <div class="modal-content-large" (click)="$event.stopPropagation()">
      
      <!-- Encabezado del modal -->
      <div class="modal-header">
        <h3>{{ modoEdicion ? 'Editar Expediente Médico' : 'Nuevo Expediente Médico' }}</h3>
        <button class="modal-close" (click)="cerrarModalInterno()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Cuerpo del modal con scroll -->
      <div class="modal-body-scroll">
        
        <form [formGroup]="formularioExpediente" class="user-form">
          
          <!-- Información básica del expediente -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-file-medical"></i> Información del Expediente
            </h4>
            <div class="form-grid">
              
              <!-- Opción de generación automática 
              <div class="form-group ancho-completo">
                <div class="grupo-checkbox">
                  <label class="etiqueta-checkbox">
                    <input 
                      type="checkbox" 
                      formControlName="generarAutomatico"
                      (change)="alCambiarGeneracionAutomatica()"
                    >
                    <span class="marca-verificacion"></span>
                    Generar número de expediente automáticamente
                  </label>
                </div>
              </div> -->

              <!-- Número de expediente manual -->
              <div class="form-group" *ngIf="!formularioExpediente.get('generarAutomatico')?.value">
                <label>Número de Expediente *</label>
                <div class="entrada-con-boton">
                  <input 
                    type="text" 
                    formControlName="numeroexpediente"
                    class="entrada-formulario"
                    [class.error]="esCampoInvalido('numeroexpediente')"
                    placeholder="Ej: EXP-2024-001, CARDIO-001"
                  >
                  <button 
                    type="button" 
                    class="boton-sugerir" 
                    (click)="sugerirNumero()"
                    title="Sugerir número automático"
                  >
                    <i class="fas fa-lightbulb"></i>
                  </button>
                </div>
                <div *ngIf="esCampoInvalido('numeroexpediente')" class="texto-error">
                  {{ obtenerErrorCampo('numeroexpediente') }}
                </div>
              </div>

              <!-- Historia de enfermedad -->
              <div class="form-group ancho-completo">
                <label>Paciente Asignado *</label>
                <div class="campo-busqueda-paciente">
                  <input 
                    type="text"
                    class="entrada-formulario"
                    placeholder="Buscar paciente por nombre o CUI..."
                    [(ngModel)]="busquedaPaciente"
                    [ngModelOptions]="{standalone: true}"
                    (focus)="abrirListaPacientes()"
                    (input)="filtrarPacientes()"
                  >
                  <i class="fas fa-search icono-busqueda"></i>
                  
                  <!-- Lista desplegable de pacientes -->
                  <div class="lista-pacientes" *ngIf="mostrarListaPacientes && pacientesFiltrados.length > 0">
                    <div 
                      *ngFor="let paciente of pacientesFiltrados" 
                      class="item-paciente"
                      (click)="seleccionarPaciente(paciente)"
                    >
                      <div class="paciente-info">
                        <div class="paciente-nombre">
                          <i class="fas fa-user-circle"></i>
                          {{ paciente.nombres }} {{ paciente.apellidos }}
                        </div>
                        <div class="paciente-cui">
                          <i class="fas fa-id-card"></i>
                          CUI: {{ paciente.cui }}
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Mensaje cuando no hay resultados -->
                  <div class="sin-resultados" *ngIf="mostrarListaPacientes && busquedaPaciente && pacientesFiltrados.length === 0">
                    <i class="fas fa-search"></i>
                    <p>No se encontraron pacientes</p>
                  </div>
                  
                  <!-- Estado de carga -->
                  <div class="cargando-pacientes" *ngIf="cargandoPacientes">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando pacientes...</p>
                  </div>
                </div>
                
                <!-- Mostrar paciente seleccionado -->
                <div class="paciente-seleccionado" *ngIf="pacienteSeleccionado">
                  <div class="info-paciente-seleccionado">
                    <i class="fas fa-check-circle"></i>
                    <div class="datos-paciente">
                      <span class="nombre-paciente">{{ pacienteSeleccionado.nombres }} {{ pacienteSeleccionado.apellidos }}</span>
                      <small class="cui-paciente">CUI: {{ pacienteSeleccionado.cui }}</small>
                    </div>
                  </div>
                  <button 
                    type="button" 
                    class="btn-cambiar-paciente"
                    (click)="cambiarPaciente()"
                    title="Cambiar paciente"
                  >
                    <i class="fas fa-sync-alt"></i>
                    Cambiar
                  </button>
                </div>
                <label>Historia de Enfermedad</label>
                <textarea
                  formControlName="historiaenfermedad"
                  class="area-texto-formulario grande"
                  rows="4"
                  placeholder="Describa la historia de enfermedad del paciente..."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Antecedentes médicos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-notes-medical"></i> Antecedentes Médicos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Antecedentes Médicos</label>
                <textarea
                  formControlName="antmedico"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Diabetes, hipertensión, cardiopatías, etc."
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes de Medicamentos</label>
                <textarea
                  formControlName="antmedicamento"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Medicamentos actuales o previos"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes Traumáticos</label>
                <textarea
                  formControlName="anttraumaticos"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Fracturas, accidentes, cirugías previas"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes Familiares</label>
                <textarea
                  formControlName="antfamiliar"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Enfermedades hereditarias en la familia"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes Alérgicos</label>
                <textarea
                  formControlName="antalergico"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Alergias conocidas a medicamentos, alimentos, etc."
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes de Sustancias</label>
                <textarea
                  formControlName="antsustancias"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Consumo de alcohol, tabaco, drogas"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Intolerancia a Lactosa</label>
                <select formControlName="antintolerantelactosa" class="entrada-formulario">
                  <option value="">No especificado</option>
                  <option value="0">No</option>
                  <option value="1">Sí</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Antecedentes fisiológicos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-child"></i> Antecedentes Fisiológicos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Inmunizaciones</label>
                <textarea
                  formControlName="antfisoinmunizacion"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Esquema de vacunación completo"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Crecimiento y Desarrollo</label>
                <textarea
                  formControlName="antfisocrecimiento"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Desarrollo psicomotor normal/anormal"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Hábitos de Vida</label>
                <textarea
                  formControlName="antfisohabitos"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Ejercicio, sueño, actividades recreativas"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Hábitos Alimenticios</label>
                <textarea
                  formControlName="antfisoalimentos"
                  class="area-texto-formulario"
                  rows="3"
                  placeholder="Tipo de alimentación, restricciones dietéticas"
                ></textarea>
              </div>
            </div>
          </div>

          <!-- Antecedentes gineco-obstétricos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-female"></i> Antecedentes Gineco-Obstétricos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Antecedentes Prenatales</label>
                <textarea
                  formControlName="gineobsprenatales"
                  class="area-texto-formulario"
                  rows="2"
                  placeholder="Embarazos previos, complicaciones"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes Natales</label>
                <textarea
                  formControlName="gineobsnatales"
                  class="area-texto-formulario"
                  rows="2"
                  placeholder="Partos previos, tipo de parto"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Antecedentes Postnatales</label>
                <textarea
                  formControlName="gineobspostnatales"
                  class="area-texto-formulario"
                  rows="2"
                  placeholder="Puerperios, complicaciones postparto"
                ></textarea>
              </div>

              <div class="form-group">
                <label>Número de Gestas</label>
                <input 
                  type="number" 
                  formControlName="gineobsgestas"
                  class="entrada-formulario"
                  min="0"
                  placeholder="Total de embarazos"
                >
              </div>

              <div class="form-group">
                <label>Número de Partos</label>
                <input 
                  type="number" 
                  formControlName="gineobspartos"
                  class="entrada-formulario"
                  min="0"
                  placeholder="Partos a término"
                >
              </div>

              <div class="form-group">
                <label>Número de Abortos</label>
                <input 
                  type="number" 
                  formControlName="gineobsabortos"
                  class="entrada-formulario"
                  min="0"
                  placeholder="Abortos espontáneos o inducidos"
                >
              </div>

              <div class="form-group">
                <label>Número de Cesáreas</label>
                <input 
                  type="number" 
                  formControlName="gineobscesareas"
                  class="entrada-formulario"
                  min="0"
                  placeholder="Partos por cesárea"
                >
              </div>

              <div class="form-group">
                <label>Fecha de Última Regla (FUR)</label>
                <input 
                  type="date" 
                  formControlName="gineobsfur"
                  class="entrada-formulario"
                >
              </div>

              <div class="form-group">
                <label>Ciclos Menstruales</label>
                <input 
                  type="text" 
                  formControlName="gineobsciclos"
                  class="entrada-formulario"
                  placeholder="Ej: 28 días, regulares/irregulares"
                >
              </div>

              <div class="form-group">
                <label>Menarquia</label>
                <input 
                  type="text" 
                  formControlName="gineobsmenarquia"
                  class="entrada-formulario"
                  placeholder="Edad de primera menstruación"
                >
              </div>
            </div>
          </div>

          <!-- Examen físico -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-stethoscope"></i> Examen Físico y Signos Vitales
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Temperatura Corporal (°C)</label>
                <input 
                  type="number" 
                  formControlName="examenfistc"
                  class="entrada-formulario"
                  step="0.1"
                  min="0"
                  max="999.99"
                  placeholder="36.5"
                >
              </div>

              <div class="form-group">
                <label>Presión Arterial (mmHg)</label>
                <input 
                  type="text" 
                  formControlName="examenfispa"
                  class="entrada-formulario"
                  placeholder="120/80"
                  pattern="^\d{2,3}/\d{2,3}$"
                >
              </div>

              <div class="form-group">
                <label>Frecuencia Cardíaca (lpm)</label>
                <input 
                  type="number" 
                  formControlName="examenfisfc"
                  class="entrada-formulario"
                  min="0"
                  max="999"
                  placeholder="80"
                >
              </div>

              <div class="form-group">
                <label>Frecuencia Respiratoria (rpm)</label>
                <input 
                  type="number" 
                  formControlName="examenfisfr"
                  class="entrada-formulario"
                  min="0"
                  max="999"
                  placeholder="18"
                >
              </div>

              <div class="form-group">
                <label>Saturación de Oxígeno (%)</label>
                <input 
                  type="number" 
                  formControlName="examenfissao2"
                  class="entrada-formulario"
                  step="0.1"
                  min="0"
                  max="100"
                  placeholder="98.5"
                >
              </div>

              <div class="form-group">
                <label>Peso (kg)</label>
                <input 
                  type="number" 
                  formControlName="examenfispeso"
                  class="entrada-formulario"
                  step="0.1"
                  min="0"
                  max="9999.99"
                  placeholder="70.5"
                  (input)="calcularIMC()"
                >
              </div>

              <div class="form-group">
                <label>Talla (metros)</label>
                <input 
                  type="number" 
                  formControlName="examenfistalla"
                  class="entrada-formulario"
                  step="0.01"
                  min="0"
                  max="999.99"
                  placeholder="1.75"
                  (input)="calcularIMC()"
                >
              </div>

              <div class="form-group">
                <label>Índice de Masa Corporal (kg/m²)</label>
                <input 
                  type="number" 
                  formControlName="examenfisimc"
                  class="entrada-formulario imc-solo-lectura"
                  step="0.1"
                  readonly
                  placeholder="Calculado automáticamente"
                >
                <small class="informacion-imc">{{ obtenerCategoriaIMC() }}</small>
              </div>

              <div class="form-group ancho-completo">
                <label>Examen Físico General</label>
                <textarea
                  formControlName="examenfisgmt"
                  class="area-texto-formulario grande"
                  rows="4"
                  placeholder="Descripción detallada del examen físico general del paciente..."
                ></textarea>
              </div>
            </div>
          </div>

        </form>
      </div>

      <!-- Pie del modal fijo -->
      <div class="modal-footer">
        <div *ngIf="!isViewMode" class="modal-actions">
          <button type="button" class="btn-cancel" (click)="cerrarModalInterno()">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button 
            type="button"
            class="btn-save" 
            (click)="alEnviarConDepuracion()"
            [disabled]="formularioExpediente.invalid || cargando"
          >
            <span *ngIf="cargando">
              <i class="fas fa-spinner fa-spin"></i> Guardando...
            </span>
            <span *ngIf="!cargando">
              <i class="fas fa-save"></i> {{ modoEdicion ? 'Actualizar' : 'Crear' }} Expediente
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Vista de detalles - MODAL COMPLETO -->
  <div class="modal-backdrop" *ngIf="vistaActual === 'detalle'" (click)="mostrarLista()">
    <div class="modal-content-large" (click)="$event.stopPropagation()">
      
      <!-- Encabezado del modal -->
      <div class="modal-header">
        <h3>Detalles del Expediente: {{ expedienteSeleccionado?.numeroexpediente }}</h3>
        <button class="modal-close" (click)="mostrarLista()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Cuerpo del modal con scroll -->
      <div class="modal-body-scroll" *ngIf="expedienteSeleccionado">
        <form class="user-form">
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-file-medical"></i> Información del Expediente
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Número de Expediente:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.numeroexpediente || 'N/A' }}</div>
              </div>
              <div class="form-group">
                <label>Fecha de Creación:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.fechacreacion | date:'dd/MM/yyyy HH:mm' }}</div>
              </div>
              <div class="form-group">
                <label>Usuario que Creó:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.usuariocreacion || 'N/A' }}</div>
              </div>
              <div class="form-group ancho-completo" *ngIf="expedienteSeleccionado.historiaenfermedad">
                <label>Historia de Enfermedad:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.historiaenfermedad }}</div>
              </div>
            </div>
          </div>

          <!-- Paciente asignado -->
          <div class="form-section" *ngIf="expedienteSeleccionado.paciente && expedienteSeleccionado.paciente.length > 0">
            <h4 class="section-title">
              <i class="fas fa-user"></i> Paciente Asignado
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Nombre Completo:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.paciente[0].nombres }} {{ expedienteSeleccionado.paciente[0].apellidos }}</div>
              </div>
              <div class="form-group">
                <label>CUI:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.paciente[0].cui }}</div>
              </div>
            </div>
          </div>

          <!-- Antecedentes médicos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-notes-medical"></i> Antecedentes Médicos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Antecedentes Médicos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antmedico || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes de Medicamentos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antmedicamento || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes Traumáticos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.anttraumaticos || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes Familiares:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antfamiliar || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes Alérgicos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antalergico || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes de Sustancias:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antsustancias || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Intolerancia a Lactosa:</label>
                <div class="campo-lectura">{{ obtenerTextoIntoleranciaLactosa(expedienteSeleccionado.antintolerantelactosa) }}</div>
              </div>
            </div>
          </div>

          <!-- Antecedentes fisiológicos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-child"></i> Antecedentes Fisiológicos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Inmunizaciones:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antfisoinmunizacion || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Crecimiento y Desarrollo:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antfisocrecimiento || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Hábitos de Vida:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antfisohabitos || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Hábitos Alimenticios:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.antfisoalimentos || 'No especificado' }}</div>
              </div>
            </div>
          </div>

          <!-- Antecedentes gineco-obstétricos -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-female"></i> Antecedentes Gineco-Obstétricos
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Antecedentes Prenatales:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsprenatales || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes Natales:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsnatales || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Antecedentes Postnatales:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobspostnatales || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Número de Gestas:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsgestas ?? 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Número de Partos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobspartos ?? 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Número de Abortos:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsabortos ?? 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Número de Cesáreas:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobscesareas ?? 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Fecha de Última Regla (FUR):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsfur ? (expedienteSeleccionado.gineobsfur | date:'dd/MM/yyyy') : 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Ciclos Menstruales:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsciclos || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Menarquia:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.gineobsmenarquia || 'No especificado' }}</div>
              </div>
            </div>
          </div>

          <!-- Examen físico -->
          <div class="form-section">
            <h4 class="section-title">
              <i class="fas fa-stethoscope"></i> Examen Físico y Signos Vitales
            </h4>
            <div class="form-grid">
              <div class="form-group">
                <label>Temperatura Corporal (°C):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfistc || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Presión Arterial (mmHg):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfispa || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Frecuencia Cardíaca (lpm):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfisfc || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Frecuencia Respiratoria (rpm):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfisfr || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Saturación de Oxígeno (%):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfissao2 || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Peso (kg):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfispeso || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Talla (metros):</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfistalla || 'No especificado' }}</div>
              </div>
              <div class="form-group">
                <label>Índice de Masa Corporal (kg/m²):</label>
                <div class="campo-lectura">
                  {{ expedienteSeleccionado.examenfisimc ? 
                      (expedienteSeleccionado.examenfisimc + ' (' + obtenerCategoriaIMCDesdeValor(expedienteSeleccionado.examenfisimc) + ')') : 
                      'No especificado' }}
                </div>
              </div>
              <div class="form-group ancho-completo">
                <label>Examen Físico General:</label>
                <div class="campo-lectura">{{ expedienteSeleccionado.examenfisgmt || 'No especificado' }}</div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Pie del modal fijo -->
      <div class="modal-footer">
        <div class="modal-actions">
          <button type="button" class="btn-pdf" (click)="descargarPDFExpediente(expedienteSeleccionado!)">
            <i class="fas fa-file-pdf"></i> Descargar PDF
          </button>
          <button type="button" class="btn-editar" (click)="editarExpediente(expedienteSeleccionado!)">
            <i class="fas fa-edit"></i> Editar Expediente
          </button>
          <button type="button" class="btn-cancel" (click)="mostrarLista()">
            <i class="fas fa-times"></i> Cerrar
          </button>
        </div>
      </div>

    </div>
  </div>

</div>